<!--
* Copyright (c) 2020, Ford Motor Company
* All rights reserved.
*
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions are met:
*
* Redistributions of source code must retain the above copyright notice, this
* list of conditions and the following disclaimer.
*
* Redistributions in binary form must reproduce the above copyright notice,
* this list of conditions and the following
* disclaimer in the documentation and/or other materials provided with the
* distribution.
*
* Neither the name of the Ford Motor Company nor the names of
* its contributors may be used to endorse or promote products derived
* from this software without specific prior written permission.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
* ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
* LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
* CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
* CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
* ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
* POSSIBILITY OF SUCH DAMAGE.
-->

<html>

<head>
    <script src='./SDL.min.js'></script>

    <script type='module'>
        import sdl_manifest from './manifest.js';

        class HelloSdl {
            constructor () {
                this._lifecycleConfig = new SDL.manager.LifecycleConfig()
                    .loadManifest(sdl_manifest)
                    .setAppTypes([SDL.rpc.enums.AppHMIType.WEB_VIEW])
                    .setLanguageDesired(SDL.rpc.enums.Language.EN_US)
                    .setHmiDisplayLanguageDesired(SDL.rpc.enums.Language.EN_US)
                    .setTransportConfig(new SDL.transport.WebSocketClientConfig());

                this._appConfig = new SDL.manager.AppConfig()
                    .setLifecycleConfig(this._lifecycleConfig);

                const managerListener = new SDL.manager.SdlManagerListener();
                managerListener
                    .setOnStart((sdlManager) => {
                        this._permissionManager = this._sdlManager.getPermissionManager();
                        this._logPermissions();
                        this._permissionManager.addListener(
                            [
                                new SDL.manager.permission.PermissionElement(
                                    SDL.rpc.enums.FunctionID.SubscribeVehicleData,
                                    [
                                        'accPedalPosition',
                                        'gps',
                                        'fuelLevel',
                                        'odometer',
                                        'prndl',
                                    ]
                                ),
                            ],
                            SDL.manager.permission.enums.PermissionGroupType.ANY,
                            (allowedPermissions, permissionGroupStatus) => {
                                console.log('SubscribeVehicleData permissions changed!');
                                console.log('Allowed Permissions: ', allowedPermissions);
                                console.log('Permission Group Status: ', permissionGroupStatus);
                                this._logPermissions();
                            }
                        );
                        this._onConnected();
                    })
                    .setOnError((sdlManager, info) => {
                        console.error('Error from SdlManagerListener: ', info);
                    });

                this._sdlManager = new SDL.manager.SdlManager(this._appConfig, managerListener);
                this._sdlManager
                    .start()
                    .addRpcListener(SDL.rpc.enums.FunctionID.OnHMIStatus, this._onHmiStatusListener.bind(this));

                this._isFirstActivation = true;
            }

            async _onConnected () {
                // add voice commands for when the managers are ready
                const screenManager = this._sdlManager.getScreenManager();
                screenManager.setVoiceCommands([
                    new SDL.manager.screen.utils.VoiceCommand(['Option 1'], () => {
                        console.log('Option one selected!');
                    }),
                    new SDL.manager.screen.utils.VoiceCommand(['Option 2'], () => {
                        console.log('Option two selected!');
                    }),
                    new SDL.manager.screen.utils.VoiceCommand(['Option 3'], () => {
                        console.log('Option three selected!');
                    }),
                ]);

                // set up the presentation for the manager when its ready
                screenManager.setTextField1('Hello SDL!');
                screenManager.setTextField2('こんにちは');
                screenManager.setTextField3('你好');
                screenManager.setTitle('JavaScript Library');
                screenManager.setTextAlignment(SDL.rpc.enums.TextAlignment.RIGHT_ALIGNED);
                screenManager.setPrimaryGraphic(new SDL.manager.file.filetypes.SdlArtwork('sdl-logo', SDL.rpc.enums.FileType.GRAPHIC_PNG)
                    .setFilePath(sdl_manifest.appIcon));
            }

            async _onHmiStatusListener (onHmiStatus) {
                const hmiLevel = onHmiStatus.getHmiLevel();
                console.log('HMI status:', hmiLevel);
                if (this._hmiLevel === hmiLevel) {
                    return;
                }

                if (this._isFirstActivation && hmiLevel === SDL.rpc.enums.HMILevel.HMI_FULL) {
                    this._isFirstActivation = false;
                    return;
                }

                this._hmiLevel = hmiLevel;
                this._logPermissions();

                // wait for the FULL state for more functionality
                if (hmiLevel === SDL.rpc.enums.HMILevel.HMI_FULL) {
                    await this._sleep(2000);

                    const count = 3;
                    for (let i = 0; i < count; i++) {
                        const showCountdown = new SDL.rpc.messages.Show();
                        showCountdown.setMainField1(`Starting in ${(count - i).toString()}`)
                            .setMainField2('')
                            .setMainField3('');

                        this._sdlManager.sendRpcResolve(showCountdown); // don't wait for a response

                        await this._sleep();
                    }

                    const art1 = new SDL.manager.file.filetypes.SdlArtwork('logo', SDL.rpc.enums.FileType.GRAPHIC_PNG)
                        .setFilePath(sdl_manifest.appIcon);

                    let state1 = new SDL.manager.screen.utils.SoftButtonState('ROCK', 'rock', art1);
                    let state2 = new SDL.manager.screen.utils.SoftButtonState('PAPER', 'paper', art1);
                    let state3 = new SDL.manager.screen.utils.SoftButtonState('SCISSORS', 'scissors', art1);
                    let state4 = new SDL.manager.screen.utils.SoftButtonState('BUTTON', 'button');

                    let softButtonObjects = [
                        new SDL.manager.screen.utils.SoftButtonObject('game', [state1, state2, state3], 'ROCK', (id, rpc) => {
                            if (rpc instanceof SDL.rpc.messages.OnButtonPress) {
                                console.log('First button pressed!');
                            }
                        }),
                        new SDL.manager.screen.utils.SoftButtonObject('button', [state4], 'BUTTON', (id, rpc) => {
                            if (rpc instanceof SDL.rpc.messages.OnButtonPress) {
                                console.log('Second button pressed!');
                            }
                        }),
                    ];

                    // set the softbuttons now and rotate through the states of the first softbutton
                    const screenManager = this._sdlManager.getScreenManager();
                    await screenManager.setSoftButtonObjects(softButtonObjects);

                    await this._sleep(2000);
                    softButtonObjects[0].transitionToNextState();
                    await this._sleep(2000);
                    softButtonObjects[0].transitionToNextState();

                    const show_template = new SDL.rpc.messages.Show();
                    show_template.setTemplateTitle("DEFAULT");

                    const configuration = new SDL.rpc.structs.TemplateConfiguration();
                    configuration.setTemplate("DEFAULT");
                    show_template.setTemplateConfiguration(configuration);

                    await this._sdlManager.sendRpcResolve(show_template);
                }
            }

            async _sleep (timeout = 1000) {
                return new Promise((resolve) => {
                    setTimeout(resolve, timeout);
                });
            }

            _logPermissions () {
                if (this._permissionManager) {
                    console.log(`Show RPC allowed: ${this._permissionManager.isRpcAllowed(SDL.rpc.enums.FunctionID.Show)}`);
                    console.log(`PutFile RPC allowed: ${this._permissionManager.isRpcAllowed(SDL.rpc.enums.FunctionID.PutFile)}`);
                    console.log(`GetVehicleData RPC allowed: ${this._permissionManager.isRpcAllowed(SDL.rpc.enums.FunctionID.GetVehicleData)}`);
                    console.log(`SubscribeVehicleData RPC allowed: ${this._permissionManager.isRpcAllowed(SDL.rpc.enums.FunctionID.SubscribeVehicleData)}`);
                }
            }

        }

        console.log('start app');
        const app = new HelloSdl();

        let cmd_counter = 0;
        document.getElementById("addButton").addEventListener("click", function(){
            cmd_counter++;

            const menu_params = new SDL.rpc.structs.MenuParams();
            menu_params.setMenuName("Test item " + cmd_counter)
                .setPosition(cmd_counter)
                .setParentID(0);

            const add_command = new SDL.rpc.messages.AddCommand();
            add_command.setCmdID(cmd_counter)
                .setMenuParams(menu_params);

            app._sdlManager.sendRpcResolve(add_command);
        });

        document.getElementById("delButton").addEventListener("click", function(){
            if (cmd_counter === 0) {
                return;
            }
            const del_command = new SDL.rpc.messages.DeleteCommand();
            del_command.setCmdID(cmd_counter);

            app._sdlManager.sendRpcResolve(del_command);
            cmd_counter--;
        });

        document.getElementById("alertButton").addEventListener("click", function(){
            const alert = new SDL.rpc.messages.Alert();
            alert.setAlertText1("Test Alert")
                 .setDuration(5000);

            const btn1 = new SDL.rpc.structs.SoftButton();
            btn1.setSystemAction(SDL.rpc.enums.SystemAction.DEFAULT_ACTION)
                .setType(SDL.rpc.enums.SoftButtonType.SBT_TEXT)
                .setText("ReRoute")
                .setSoftButtonID(5502);

            const btn2 = new SDL.rpc.structs.SoftButton();
            btn2.setSystemAction(SDL.rpc.enums.SystemAction.DEFAULT_ACTION)
                .setType(SDL.rpc.enums.SoftButtonType.SBT_TEXT)
                .setText("Close")
                .setSoftButtonID(5503);

            alert.setSoftButtons([btn1, btn2])

            app._sdlManager.sendRpcResolve(alert);
        });

        document.getElementById("unregButton").addEventListener("click", async function(){
            // tear down the app
            await app._sdlManager.sendRpcResolve(new SDL.rpc.messages.UnregisterAppInterface());

            app._sdlManager.dispose();
        });

        let widget_counter = 1;
        document.getElementById("addWidget").addEventListener("click", function(){
            const create_window = new SDL.rpc.messages.CreateWindow();
            create_window.setWindowID(widget_counter)
                         .setWindowName("Test widget " + widget_counter)
                         .setType(SDL.rpc.enums.WindowType.WIDGET);

            if (document.getElementById("DuplicateMainWindow").checked) {
                create_window.setDuplicateUpdatesFromWindowID(0);
            }

            let option = document.createElement("option");
            option.text = "Widget " + widget_counter;
            option.value = widget_counter;
            document.getElementById("LayoutWindowId").appendChild(option);

            widget_counter++;

            app._sdlManager.sendRpcResolve(create_window);
        });

        document.getElementById("delWidget").addEventListener("click", function(){
            if (widget_counter === 1) {
                return;
            }

            let LayoutWindowId = document.getElementById("LayoutWindowId");
            LayoutWindowId.removeChild(LayoutWindowId.lastElementChild);
            LayoutWindowId.dispatchEvent(new Event('change'));
            widget_counter--;

            const delete_window = new SDL.rpc.messages.DeleteWindow();
            delete_window.setWindowID(widget_counter);

            app._sdlManager.sendRpcResolve(delete_window);
        });

        document.getElementById("setLayout").addEventListener("click", function(){
            const template_name = document.getElementById("LayoutCombo").value;
            const window_id = document.getElementById("LayoutWindowId").value;

            const show_template = new SDL.rpc.messages.Show();
            show_template.setTemplateTitle(template_name);

            if (window_id != "MAIN") {
                show_template.setWindowID(parseInt(window_id));
            }

            const main_field1 = document.getElementById('mainField1').value;
            show_template.setMainField1(main_field1);

            const main_field2 = document.getElementById('mainField2').value;
            show_template.setMainField2(main_field2);

            const main_field3 = document.getElementById('mainField3').value;
            show_template.setMainField3(main_field3);

            const main_field4 = document.getElementById('mainField4').value;
            show_template.setMainField4(main_field4);

            const btns_count = parseInt(document.getElementById('SoftButtonsCount').value);
            let soft_buttons = [];
            for (let i = 0; i < btns_count; ++i) {
                const soft_button = new SDL.rpc.structs.SoftButton();
                soft_button
                    .setSoftButtonID(i)
                    .setType(SDL.rpc.enums.SoftButtonType.SBT_TEXT)
                    .setText(String(i + 1));
                soft_buttons.push(soft_button);
            }

            show_template.setSoftButtons(soft_buttons);

            const configuration = new SDL.rpc.structs.TemplateConfiguration();
            configuration.setTemplate(template_name);
            show_template.setTemplateConfiguration(configuration);

            app._sdlManager.sendRpcResolve(show_template);
        });

        document.getElementById("LayoutWindowId").addEventListener('change', (event) => {
            const items = event.target.value == "MAIN" ?
                ["DEFAULT", "MEDIA", "NON-MEDIA", "NAV_FULLSCREEN_MAP", "WEB_VIEW"] :
                ["TEXT_WITH_GRAPHIC", "BUTTONS_WITH_GRAPHIC", "GRAPHIC_WITH_TEXT"];

            var content = "";
            for (let item of items) {
                content += "<option>" + item + "</option>";
            }

            document.getElementById("LayoutCombo").innerHTML = content;
        });

        // refresh items in layouts combobox
        document.getElementById("LayoutWindowId").dispatchEvent(new Event('change'));

        document.getElementById("showAppMenu").addEventListener("click", function(){
            const show_app_menu = new SDL.rpc.messages.ShowAppMenu();

            app._sdlManager.sendRpcResolve(show_app_menu);
        });

        document.getElementById("closeApplication").addEventListener("click", function(){
            const close_app = new SDL.rpc.messages.CloseApplication();

            app._sdlManager.sendRpcResolve(close_app);
        });

    </script>
</head>


<body>
    <marquee direction="down" width="100%" height="100%" behavior="alternate" style="color: lime;">
        <marquee behavior="alternate">
            WebEngine App Testing
        </marquee>
    </marquee>
    <button id="addButton" style="
        cursor: pointer;
        position: absolute;
        top: 5px;
        left: 5px;">Add command
    </button>
    <button id="delButton" style="
        cursor: pointer;
        position: absolute;
        top: 30px;
        left: 5px;">Delete command
    </button>
    <button id="alertButton" style="
        cursor: pointer;
        position: absolute;
        top: 55px;
        left: 5px;">Alert command
    </button>
    <button id="setLayout" style="
        cursor: pointer;
        position: absolute;
        top: 80px;
        left: 5px;">Send Show
    </button>
    <select style="position: absolute; top: 80px; left: 100px; width: 80px;"  id="LayoutWindowId">
        <option selected="">MAIN</option>
    </select>
    <select style="position: absolute; top: 80px; left: 185px; width: 185px;" id="LayoutCombo">
    </select>
    <input style="position: absolute; top: 80px; left: 380px; width: 75px;" id="mainField1" placeholder="Field 1">
    <input style="position: absolute; top: 80px; left: 460px; width: 75px;" id="mainField2" placeholder="Field 2">
    <input style="position: absolute; top: 80px; left: 540px; width: 75px;" id="mainField3" placeholder="Field 3">
    <input style="position: absolute; top: 80px; left: 620px; width: 75px;" id="mainField4" placeholder="Field 4">
    <label style="position: absolute; top: 64px; left: 700px; width: 51px; font-size: 14px; text-align: center; color: white;">
        Buttons:
    </label>
    <select style="position: absolute;top: 80px;left: 700px;width: 50px;" id="SoftButtonsCount">
        <option>0</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
    </select>
    <button id="addWidget" style="
        cursor: pointer;
        position: absolute;
        top: 105px;
        left: 5px;">Add Widget
    </button>
    <input type="checkbox" id="DuplicateMainWindow" style="position: absolute; top: 107px; left: 100px;">
    <label for="DuplicateMainWindow" style="position: absolute; top: 108px; left: 123px; font-size: 15px; color: white;">
        Duplicate MAIN window?
    </label>
    <button id="delWidget" style="
        cursor: pointer;
        position: absolute;
        top: 130px;
        left: 5px;">Del Widget
    </button>
    <button id="showAppMenu" style="
        cursor: pointer;
        position: absolute;
        top: 155px;
        left: 5px;">Show menu
    </button>
    <button id="closeApplication" style="
        cursor: pointer;
        position: absolute;
        top: 180px;
        left: 5px;">Close app
    </button>
    <button id="unregButton" style="
        cursor: pointer;
        position: absolute;
        top: 205px;
        left: 5px;">Unregister
    </button>
</body>

</html>
